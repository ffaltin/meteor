!function(e,t,o){"use strict";function i(){F=t.$body}function s(o){o.multiple=this.prop("multiple"),o.disabled=this.is(":disabled"),o.multiple?o.links=!1:o.external&&(o.links=!0);var i=this.find(":selected").not(":disabled"),s=i.text(),l=this.find("option").index(i);o.multiple||""===o.label?o.label="":(i=this.prepend('<option value="" class="'+O.item_placeholder+'" selected>'+o.label+"</option>"),s=o.label,l=0);var n=this.find("option, optgroup"),d=n.filter("option");o.tabIndex=this[0].tabIndex,this[0].tabIndex=-1;var a=[O.base,o.customClass];o.mobile||t.isMobile?a.push(O.mobile):o.cover&&a.push(O.cover),o.multiple&&a.push(O.multiple),o.disabled&&a.push(O.disabled);var c='<div class="'+a.join(" ")+'" tabindex="'+o.tabIndex+'"></div>',u="";o.multiple||(u+='<button type="button" class="'+O.selected+'">',u+=e("<span></span>").text(y(s,o.trim)).html(),u+="</button>"),u+='<div class="'+O.options+'">',u+="</div>",this.wrap(c).after(u),o.$dropdown=this.parent(q.base),o.$allOptions=n,o.$options=d,o.$selected=o.$dropdown.find(q.selected),o.$wrapper=o.$dropdown.find(q.options),o.$placeholder=o.$dropdown.find(q.placeholder),o.index=-1,o.closed=!0,o.focused=!1,r(o),o.multiple||x(l,o),o.$selected.fsTouch({tap:!0}).on(T.tap,o,p),o.$dropdown.on(T.click,q.item,o,v).on(T.close,o,$),this.on(T.change,o,b),t.isMobile||(o.$dropdown.on(T.focusIn,o,h).on(T.focusOut,o,w),this.on(T.focusIn,o,function(e){e.data.$dropdown.trigger(T.raw.focusIn)}))}function l(e){e.$dropdown.hasClass(O.open)&&e.$selected.trigger(T.click),e.$el[0].tabIndex=e.tabIndex,e.$dropdown.off(T.namespace),e.$options.off(T.namespace),e.$placeholder.remove(),e.$selected.fsTouch("destroy").remove(),e.$wrapper.remove(),e.$el.off(T.namespace).show().unwrap()}function n(e,t){if("undefined"!=typeof t){var o=e.$items.index(e.$items.filter("[data-value="+t+"]"));e.$items.eq(o).addClass(O.item_disabled),e.$options.eq(o).prop("disabled",!0)}else e.$dropdown.hasClass(O.open)&&e.$selected.trigger(T.click),e.$dropdown.addClass(O.disabled),e.$el.prop("disabled",!0),e.disabled=!0}function d(e,t){if("undefined"!=typeof t){var o=e.$items.index(e.$items.filter("[data-value="+t+"]"));e.$items.eq(o).removeClass(O.item_disabled),e.$options.eq(o).prop("disabled",!1)}else e.$dropdown.removeClass(O.disabled),e.$el.prop("disabled",!1),e.disabled=!1}function a(e){var t=e.index;e.$allOptions=e.$el.find("option, optgroup"),e.$options=e.$allOptions.filter("option"),e.index=-1,t=e.$options.index(e.$options.filter(":selected")),r(e),e.multiple||x(t,e)}function r(t){for(var o="",i=0,s=0,l=t.$allOptions.length;l>s;s++){var n=t.$allOptions.eq(s),d=[];if("OPTGROUP"===n[0].tagName)d.push(O.group),n.is(":disabled")&&d.push(O.disabled),o+='<span class="'+d.join(" ")+'">'+n.attr("label")+"</span>";else{var a=n.val();n.attr("value")||n.attr("value",a),d.push(O.item),n.hasClass(O.item_placeholder)&&d.push(O.item_placeholder),n.is(":selected")&&d.push(O.item_selected),n.is(":disabled")&&d.push(O.item_disabled),o+='<button type="button" class="'+d.join(" ")+'" ',o+='data-value="'+a+'">',o+=e("<span></span>").text(y(n.text(),t.trim)).html(),o+="</button>",i++}}t.$items=t.$wrapper.html(o).find(q.item)}function p(e){M.killEvent(e);var o=e.data;if(!o.disabled)if(o.mobile||!t.isMobile||t.isFirefoxMobile)o.closed?u(o):f(o);else{var i=o.$el[0];if(G.createEvent){var s=G.createEvent("MouseEvents");s.initMouseEvent("mousedown",!1,!0,j,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(s)}else i.fireEvent&&i.fireEvent("onmousedown")}c(o)}function c(t){e(q.base).not(t.$dropdown).trigger(T.close,[t])}function u(e){if(e.closed){var t=e.$dropdown.offset(),o=F.outerHeight(),i=e.$wrapper.outerHeight(!0);e.index>=0?e.$items.eq(e.index).position():{left:0,top:0};t.top+i>o&&e.$dropdown.addClass(O.bottom),F.on(T.click+e.dotGuid,":not("+q.options+")",e,m),e.$dropdown.trigger(T.focusIn),e.$dropdown.addClass(O.open),C(e),e.closed=!1}}function f(e){e&&!e.closed&&(F.off(T.click+e.dotGuid),e.$dropdown.removeClass([O.open,O.bottom].join(" ")),e.closed=!0)}function m(t){M.killEvent(t);var o=t.data;o&&0===e(t.currentTarget).parents(q.base).length&&(f(o),o.$dropdown.trigger(T.focusOut))}function $(e){var t=e.data;t&&(f(t),t.$dropdown.trigger(T.focusOut))}function v(t){M.killEvent(t);var o=e(this),i=t.data;if(!i.disabled){if(i.$wrapper.is(":visible")){var s=i.$items.index(o);s!==i.index&&(x(s,i),k(i))}i.multiple||f(i),i.$dropdown.trigger(T.focusIn)}}function b(t,o){var i=e(this),s=t.data;if(!o&&!s.multiple){var l=s.$options.index(s.$options.filter("[value='"+E(i.val())+"']"));x(l,s),k(s)}}function h(t){M.killEvent(t);var o=(e(t.currentTarget),t.data);o.disabled||o.multiple||o.focused||(c(o),o.focused=!0,o.$dropdown.addClass(O.focus).on(T.keyDown+o.dotGuid,o,g))}function w(t,o){M.killEvent(t);var i=(e(t.currentTarget),t.data);i.focused&&i.closed&&(i.focused=!1,i.$dropdown.removeClass(O.focus).off(T.keyDown+i.dotGuid),i.multiple||f(i))}function g(o){var i=o.data;if(13===o.keyCode)i.closed||(f(i),x(i.index,i)),k(i);else if(!(9===o.keyCode||o.metaKey||o.altKey||o.ctrlKey||o.shiftKey)){M.killEvent(o);var s=i.$items.length-1,l=i.index<0?0:i.index;if(e.inArray(o.keyCode,t.isFirefox?[38,40,37,39]:[38,40])>-1)l+=38===o.keyCode||t.isFirefox&&37===o.keyCode?-1:1,0>l&&(l=0),l>s&&(l=s);else{var n,d,a=String.fromCharCode(o.keyCode).toUpperCase();for(d=i.index+1;s>=d;d++)if(n=i.$options.eq(d).text().charAt(0).toUpperCase(),n===a){l=d;break}if(0>l||l===i.index)for(d=0;s>=d;d++)if(n=i.$options.eq(d).text().charAt(0).toUpperCase(),n===a){l=d;break}}l>=0&&(x(l,i),C(i))}}function x(e,t){var o=t.$items.eq(e),i=t.$options.eq(e),s=o.hasClass(O.item_selected),l=o.hasClass(O.item_disabled);if(!l)if(t.multiple)s?(i.prop("selected",null),o.removeClass(O.item_selected)):(i.prop("selected",!0),o.addClass(O.item_selected));else if(e>-1&&e<t.$items.length){var n=i.data("label")||o.html();t.$selected.html(n).removeClass(q.item_placeholder),t.$items.filter(q.item_selected).removeClass(O.item_selected),t.$el[0].selectedIndex=e,o.addClass(O.item_selected),t.index=e}else""!==t.label&&t.$selected.html(t.label)}function C(e){var t=e.$items.eq(e.index),o=e.index>=0&&!t.hasClass(O.item_placeholder)?t.position():{left:0,top:0},i=(e.$wrapper.outerHeight()-t.outerHeight())/2;e.$wrapper.scrollTop(e.$wrapper.scrollTop()+o.top-i)}function k(e){e.links?_(e):e.$el.trigger(T.raw.change,[!0])}function _(e){var t=e.$el.val();e.external?j.open(t):j.location.href=t}function y(e,t){return 0===t?e:e.length>t?e.substring(0,t)+"...":e}function E(e){return"string"==typeof e?e.replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g,"\\$1"):e}var I=t.Plugin("dropdown",{widget:!0,defaults:{cover:!1,customClass:"",label:"",external:!1,links:!1,mobile:!1,trim:0},methods:{_setup:i,_construct:s,_destruct:l,disable:n,enable:d,update:a,open:u,close:f},classes:["cover","bottom","multiple","mobile","open","disabled","focus","selected","options","group","item","item_disabled","item_selected","item_placeholder"],events:{tap:"tap",close:"close"}}),q=I.classes,O=q.raw,T=I.events,M=I.functions,j=t.window,G=(t.$window,t.document),F=null}(jQuery,Formstone);